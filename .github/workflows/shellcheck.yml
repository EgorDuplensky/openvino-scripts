name: Shellcheck Validation

on:
  issue_comment:
    types: [created, edited]
  # optional – lets you run it from the “Actions” tab while debugging
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write
  statuses: write

jobs:
  shellcheck:
    if: github.event.issue.pull_request &&
        (contains(github.event.comment.body, '/check-shellcheck') ||
         contains(github.event.comment.body, '/check-all'))
    runs-on: ubuntu-latest

    steps:
    - name: Get PR details
      id: pr
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pullRequest } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          return {
            ref: pullRequest.head.ref,
            sha: pullRequest.head.sha,
            repo_full_name: pullRequest.head.repo.full_name
          };
    
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        repository: ${{ fromJson(steps.pr.outputs.result).repo_full_name }}
        ref: ${{ fromJson(steps.pr.outputs.result).ref }}
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Install shellcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck
    
    - name: Run shellcheck on all shell scripts
      id: shellcheck
      run: |
        echo "Running shellcheck on all shell scripts..."
        if find . -name "*.sh" -exec shellcheck {} +; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=✅ All shell scripts passed shellcheck" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "message=❌ Some shell scripts failed shellcheck" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: Update commit status
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const state = '${{ steps.shellcheck.outputs.status }}' === 'success' ? 'success' : 'failure';
          const description = '${{ steps.shellcheck.outputs.message }}';
          
          await github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: '${{ fromJson(steps.pr.outputs.result).sha }}',
            state: state,
            target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
            description: description,
            context: 'shellcheck/all-scripts'
          });
